<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slab Design Calculator</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-field {
            flex: 1 1 300px;
        }
        .input-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        #results {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr.best-cost {
            background-color: #d4efdf !important;
        }
        .chart-container {
            margin-top: 40px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Slab Design Calculator</h1>
        <div class="input-group">
            <div class="input-field">
                <label for="longerSpan">Longer Span (m):</label>
                <input type="number" id="longerSpan" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="shorterSpan">Shorter Span (m):</label>
                <input type="number" id="shorterSpan" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="liveLoad">Live Load (kN/m²):</label>
                <input type="number" id="liveLoad" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="floorFinish">Floor Finish (kN/m²):</label>
                <input type="number" id="floorFinish" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="mainBarDia">Main Bar Diameter (mm):</label>
                <input type="number" id="mainBarDia" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="distBarDia">Distribution Bar Diameter (mm):</label>
                <input type="number" id="distBarDia" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="sandRate">Sand Rate (per ton):</label>
                <input type="number" id="sandRate" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="aggregateRate">Aggregate Rate (per ton):</label>
                <input type="number" id="aggregateRate" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="cementRate">Cement Rate (per 50kg bag):</label>
                <input type="number" id="cementRate" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="steelFe415Rate">Steel Fe415 Rate (per kg):</label>
                <input type="number" id="steelFe415Rate" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="steelFe500Rate">Steel Fe500 Rate (per kg):</label>
                <input type="number" id="steelFe500Rate" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
            <div class="input-field">
                <label for="steelFe550Rate">Steel Fe550 Rate (per kg):</label>
                <input type="number" id="steelFe550Rate" step="0.01" required oninput="calculateSlabDesign()" onkeydown="moveToNext(event)">
            </div>
        </div>
        <div id="results">
            <div id="table-container"></div>
            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="depthChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2"></script>
    <script>
        const fckValues = [20, 25, 30];
        const fyValues = [415, 500, 550];
        const widthSupports = 0.23; // meters
        const barWeights = { 8: 0.395, 10: 0.617, 12: 0.89, 16: 1.58 };
        const tauTable = {
            0.15: { 'M15': 0.28, 'M20': 0.28, 'M25': 0.29, 'M30': 0.29, 'M35': 0.29, 'M40+': 0.30 },
            0.25: { 'M15': 0.35, 'M20': 0.36, 'M25': 0.36, 'M30': 0.37, 'M35': 0.37, 'M40+': 0.38 },
            0.50: { 'M15': 0.46, 'M20': 0.48, 'M25': 0.49, 'M30': 0.50, 'M35': 0.50, 'M40+': 0.51 },
            0.75: { 'M15': 0.54, 'M20': 0.56, 'M25': 0.57, 'M30': 0.59, 'M35': 0.59, 'M40+': 0.60 },
            1.00: { 'M15': 0.60, 'M20': 0.62, 'M25': 0.64, 'M30': 0.66, 'M35': 0.67, 'M40+': 0.68 },
            1.25: { 'M15': 0.64, 'M20': 0.67, 'M25': 0.70, 'M30': 0.71, 'M35': 0.73, 'M40+': 0.74 },
            1.50: { 'M15': 0.68, 'M20': 0.72, 'M25': 0.74, 'M30': 0.76, 'M35': 0.78, 'M40+': 0.79 },
            1.75: { 'M15': 0.71, 'M20': 0.75, 'M25': 0.78, 'M30': 0.80, 'M35': 0.82, 'M40+': 0.84 },
            2.00: { 'M15': 0.71, 'M20': 0.79, 'M25': 0.82, 'M30': 0.84, 'M35': 0.86, 'M40+': 0.88 },
            2.25: { 'M15': 0.71, 'M20': 0.81, 'M25': 0.85, 'M30': 0.88, 'M35': 0.90, 'M40+': 0.92 },
            2.50: { 'M15': 0.71, 'M20': 0.82, 'M25': 0.88, 'M30': 0.91, 'M35': 0.93, 'M40+': 0.95 },
            2.75: { 'M15': 0.71, 'M20': 0.82, 'M25': 0.90, 'M30': 0.94, 'M35': 0.96, 'M40+': 0.98 },
            3.00: { 'M15': 0.71, 'M20': 0.82, 'M25': 0.92, 'M30': 0.96, 'M35': 0.99, 'M40+': 1.01 }
        };

        let costChart, depthChart;

        function calculateShearStrength(Asbd_100, grade) {
            let gradeKey = grade < 40 ? `M${grade}` : 'M40+';
            if (Asbd_100 <= 0.15) return tauTable[0.15][gradeKey];
            if (Asbd_100 >= 3.00) return tauTable[3.00][gradeKey];
            let keys = Object.keys(tauTable).map(Number).sort((a, b) => a - b);
            for (let i = 1; i < keys.length; i++) {
                let lower = keys[i - 1], upper = keys[i];
                if (lower < Asbd_100 && Asbd_100 < upper) {
                    let tauLower = tauTable[lower][gradeKey];
                    let tauUpper = tauTable[upper][gradeKey];
                    return Number((tauLower + (Asbd_100 - lower) * (tauUpper - tauLower) / (upper - lower)).toFixed(3));
                }
            }
            return tauTable[Asbd_100][gradeKey];
        }

        function moveToNext(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const inputs = Array.from(document.querySelectorAll('.input-field input'));
                const currentIndex = inputs.indexOf(event.target);
                if (currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                }
            }
        }

        function calculateSlabDesign() {
            const inputs = {
                longerSpan: Number(document.getElementById('longerSpan').value) || 0,
                shorterSpan: Number(document.getElementById('shorterSpan').value) || 0,
                liveLoad: Number(document.getElementById('liveLoad').value) || 0,
                floorFinish: Number(document.getElementById('floorFinish').value) || 0,
                mainBarDia: Number(document.getElementById('mainBarDia').value) || 0,
                distBarDia: Number(document.getElementById('distBarDia').value) || 0,
                rateSand: Number(document.getElementById('sandRate').value) || 0,
                rateAggregate: Number(document.getElementById('aggregateRate').value) || 0,
                rateCement: Number(document.getElementById('cementRate').value) || 0,
                rateSteel415: Number(document.getElementById('steelFe415Rate').value) || 0,
                rateSteel500: Number(document.getElementById('steelFe500Rate').value) || 0,
                rateSteel550: Number(document.getElementById('steelFe550Rate').value) || 0
            };

            if (Object.values(inputs).some(val => val === 0)) {
                document.getElementById('table-container').innerHTML = '<p>Please fill all fields to see results.</p>';
                destroyCharts();
                return;
            }

            let results = [];
            for (let fck of fckValues) {
                for (let fy of fyValues) {
                    let aspectRatio = inputs.longerSpan / inputs.shorterSpan;
                    let slabType = aspectRatio > 2 ? "One Way" : "Two Way";
                    let effectiveDepthD = 125;
                    let effectiveCover = 25;
                    let totalDepth = Math.round((effectiveDepthD + effectiveCover) * 100) / 100;

                    let effectiveSpan = Math.round(Math.min(inputs.shorterSpan + effectiveDepthD / 1000, inputs.shorterSpan + widthSupports) * 100) / 100;
                    let deadLoadSlab = Math.round((totalDepth / 1000 * 25) * 100) / 100;
                    let deadLoadFloorFinish = Math.round(inputs.floorFinish * 100) / 100;
                    let totalDeadLoadSlab = Math.round((deadLoadSlab + deadLoadFloorFinish) * 100) / 100;
                    let wu = Math.round((1.5 * (totalDeadLoadSlab + inputs.liveLoad)) * 100) / 100;

                    let mu = Math.round((wu * effectiveSpan * effectiveSpan / 8) * 100) / 100;
                    let vu = Math.round((wu * effectiveSpan / 2) * 100) / 100;
                    let mulim = fy === 415 ? 0.138 : (fy === 500 ? 0.133 : 0.130);
                    mulim = Math.round((mulim * fck * 1000 * (effectiveDepthD * effectiveDepthD) / 1e6) * 100) / 100;

                    if (mulim <= mu) continue;

                    let astMain = Math.round((0.5 * fck / fy * (1 - Math.sqrt(1 - (4.6 * mu * 1e6) / (fck * 1000 * effectiveDepthD * effectiveDepthD))) * 1000 * effectiveDepthD) * 100) / 100;
                    let astMin = Math.round((0.0012 * 1000 * totalDepth) * 100) / 100;

                    let areaOneMainBar = Math.round((Math.PI / 4 * inputs.mainBarDia * inputs.mainBarDia) * 100) / 100;
                    let spacingMainBar = Math.round((1000 * areaOneMainBar / astMain / 10)) * 10;
                    let adoptSpacingMain = Math.floor(Math.min(3 * effectiveDepthD, 300, spacingMainBar) / 10) * 10;
                    let astMainProvided = Math.round((1000 * areaOneMainBar / adoptSpacingMain) * 100) / 100;

                    let areaOneDistBar = Math.round((Math.PI / 4 * inputs.distBarDia * inputs.distBarDia) * 100) / 100;
                    let spacingDistBar = Math.ceil((1000 * areaOneDistBar / astMin / 10)) * 10;
                    let adoptSpacingDist = Math.floor(Math.min(5 * effectiveDepthD, 450, spacingDistBar) / 10) * 10;
                    let astDistProvided = Math.round((1000 * areaOneDistBar / adoptSpacingDist) * 100) / 100;

                    let tv = Math.round((vu * 1000 / (1000 * effectiveDepthD)) * 100) / 100;
                    let pt = Math.round((100 * astMainProvided / (1000 * effectiveDepthD)) * 100) / 100;
                    let tauC = calculateShearStrength(pt, fck);
                    let designShearStrength = Number((tauC * 1.30).toFixed(3));
                    if (tv > designShearStrength) continue;
                    let shearCheck = "Safe";

                    let numMainBars = Math.ceil((inputs.longerSpan * 1000) / adoptSpacingMain) + 1;
                    let mainSteelMeters = numMainBars * inputs.shorterSpan;
                    let mainBarWeight = barWeights[inputs.mainBarDia] || 0.395;
                    let mainBarKgs = mainSteelMeters * mainBarWeight;

                    let numDistBars = Math.ceil((inputs.shorterSpan * 1000) / adoptSpacingDist) + 1;
                    let distSteelMeters = numDistBars * inputs.longerSpan;
                    let distBarWeight = barWeights[inputs.distBarDia] || 0.395;
                    let distBarKgs = distSteelMeters * distBarWeight;

                    let totalSteelWeight = Math.round((mainBarKgs + distBarKgs) * 100) / 100;

                    let totalDepthM = Math.round((totalDepth / 1000) * 100) / 100;
                    let volumeWetConcrete = Math.round((inputs.longerSpan * inputs.shorterSpan * totalDepthM) * 100) / 100;
                    let volumeDryConcrete = Math.round((volumeWetConcrete * 1.54) * 100) / 100;

                    let ratios = fck === 20 ? [1, 1.5, 3] : (fck === 25 ? [1, 1, 2] : [1, 0.75, 1.5]);
                    let totalRatio = ratios.reduce((a, b) => a + b, 0);
                    let volumeCement = Math.round((ratios[0] * volumeDryConcrete / totalRatio) * 100) / 100;
                    let volumeSand = Math.round((ratios[1] * volumeDryConcrete / totalRatio) * 100) / 100;
                    let volumeAggregate = Math.round((ratios[2] * volumeDryConcrete / totalRatio) * 100) / 100;

                    let cementInKg = Math.round((volumeCement * 1440) * 100) / 100;
                    let numCementBags = Math.round((cementInKg / 50) * 100) / 100;
                    let sandInTon = Math.round((volumeSand * 1600 / 1000) * 100) / 100;
                    let aggregateInTon = Math.round((volumeAggregate * 1450 / 1000) * 100) / 100;

                    let priceCement = Math.round((numCementBags * inputs.rateCement) * 100) / 100;
                    let steelRate = fy === 415 ? inputs.rateSteel415 : (fy === 500 ? inputs.rateSteel500 : inputs.rateSteel550);
                    let priceSteel = Math.round((totalSteelWeight * steelRate) * 100) / 100;
                    let priceSand = Math.round((sandInTon * inputs.rateSand) * 100) / 100;
                    let priceAggregate = Math.round((aggregateInTon * inputs.rateAggregate) * 100) / 100;
                    let totalPrice = Math.round((priceCement + priceSteel + priceSand + priceAggregate) * 100) / 100;

                    results.push([fck, fy, slabType, totalDepth, mulim, inputs.mainBarDia, adoptSpacingMain, inputs.distBarDia, adoptSpacingDist, shearCheck, totalSteelWeight, numCementBags, sandInTon, aggregateInTon, totalPrice]);
                }
            }

            const columns = [
                "Fck(N/mm²)",
                "Fy(N/mm²)",
                "Slab Type",
                "Total Depth(mm)",
                "Ultimate Moment of Resistance(KNm)",
                "Main Bar Dia(mm)",
                "Main Bar Spacing(mm c/c)",
                "Dist Bar Dia(mm)",
                "Dist Bar Spacing(mm c/c)",
                "Shear Check",
                "Total Steel Weight(kg)",
                "No of Cement Bags(50kg/bag)",
                "Sand (Ton)",
                "Aggregate (Ton)",
                "Total Price"
            ];
            let html = '<table><thead><tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr></thead><tbody>';
            if (results.length === 0) {
                html += '<tr><td colspan="15">No valid designs found. Adjust inputs.</td></tr>';
                destroyCharts();
            } else {
                let minPrice = Math.min(...results.map(r => r[14]));
                results.forEach(row => {
                    let isBestCost = row[14] === minPrice;
                    html += `<tr${isBestCost ? ' class="best-cost"' : ''}>` + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
                });
                html += '</tbody></table>';
                updateCharts(results);
            }
            document.getElementById('table-container').innerHTML = html;
        }

        function destroyCharts() {
            if (costChart) costChart.destroy();
            if (depthChart) depthChart.destroy();
        }

        function updateCharts(results) {
            destroyCharts();

            // Advanced Line Graph: Cost vs Combinations
            const combinations = results.map(r => `${r[0]}-${r[1]}`);
            const prices = results.map(r => r[14]);
            const costCtx = document.getElementById('costChart').getContext('2d');

            // Gradient Fill
            const gradient = costCtx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(46, 204, 113, 0.8)');
            gradient.addColorStop(1, 'rgba(46, 204, 113, 0.1)');

            costChart = new Chart(costCtx, {
                type: 'line',
                data: {
                    labels: combinations,
                    datasets: [{
                        label: 'Total Price (INR)',
                        data: prices,
                        borderColor: '#2ecc71',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#27ae60',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'nearest',
                        intersect: true
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Combinations of Fck,Fy',
                                font: { size: 14 }
                            },
                            grid: { display: false }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Price (INR)',
                                font: { size: 14 }
                            },
                            beginAtZero: true,
                            grid: { color: '#ecf0f1' }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cost vs Combinations',
                            font: { size: 18, weight: 'bold' },
                            padding: 20
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const result = results[index];
                                    return [
                                        `Price: ₹${context.raw.toLocaleString()}`,
                                        `Fck: ${result[0]} N/mm²`,
                                        `Fy: ${result[1]} N/mm²`,
                                        `Steel: ${result[10]} kg`,
                                        `Cement: ${result[11]} bags`
                                    ];
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 14 },
                            bodyFont: { size: 12 },
                            padding: 10
                        },
                        datalabels: {
                            display: true,
                            align: 'top',
                            color: '#2c3e50',
                            font: { size: 12, weight: 'bold' },
                            formatter: (value) => `₹${value.toLocaleString()}`
                        },
                        zoom: {
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'xy'
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy'
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutBounce'
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Bar Chart: Total Depth vs Ultimate Moment of Resistance
            const depths = results.map(r => r[3]);
            const moments = results.map(r => r[4]);
            const depthCtx = document.getElementById('depthChart').getContext('2d');
            depthChart = new Chart(depthCtx, {
                type: 'bar',
                data: {
                    labels: depths,
                    datasets: [{
                        label: 'Ultimate Moment of Resistance (KNm)',
                        data: moments,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Total Depth (mm)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Ultimate Moment of Resistance (KNm)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total Depth vs Ultimate Moment of Resistance (KNm)'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
